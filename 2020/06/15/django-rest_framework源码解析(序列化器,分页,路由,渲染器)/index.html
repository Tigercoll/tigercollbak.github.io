<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tigercoll.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta name="description" content="前面我们介绍了DRF的request的二次封装,解析模块,认证模块,权限模块,频率控制模块跟版本控制模块 接下来我们了解一下序列化器,分页,路由,渲染器">
<meta property="og:type" content="article">
<meta property="og:title" content="django rest_framework源码解析(序列化器,分页,路由,渲染器)">
<meta property="og:url" content="https://tigercoll.github.io/2020/06/15/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8)/index.html">
<meta property="og:site_name" content="Tigercoll&#39;s blog">
<meta property="og:description" content="前面我们介绍了DRF的request的二次封装,解析模块,认证模块,权限模块,频率控制模块跟版本控制模块 接下来我们了解一下序列化器,分页,路由,渲染器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615162415065.png">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615162415065.png">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615171020763.png">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615172017569.png">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615200917320.png">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615204626908.png">
<meta property="og:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200616101431910.png">
<meta property="article:published_time" content="2020-06-15T12:06:34.348Z">
<meta property="article:modified_time" content="2020-11-30T07:24:49.182Z">
<meta property="article:author" content="Tigercoll">
<meta property="article:tag" content="python">
<meta property="article:tag" content="django">
<meta property="article:tag" content="rest_framework">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tigercoll.github.io/images/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8B%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8/image-20200615162415065.png">

<link rel="canonical" href="https://tigercoll.github.io/2020/06/15/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8)/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>django rest_framework源码解析(序列化器,分页,路由,渲染器) | Tigercoll's blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a96c4a898a5cb3af691471bb9804141d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
	
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tigercoll's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/Tigercoll" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tigercoll.github.io/2020/06/15/django-rest_framework%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8,%E5%88%86%E9%A1%B5,%E8%B7%AF%E7%94%B1,%E6%B8%B2%E6%9F%93%E5%99%A8)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/p1.jpg">
      <meta itemprop="name" content="Tigercoll">
      <meta itemprop="description" content="万丈高楼平地起,勿在浮沙筑高台">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tigercoll's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          django rest_framework源码解析(序列化器,分页,路由,渲染器)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-15 20:06:34" itemprop="dateCreated datePublished" datetime="2020-06-15T20:06:34+08:00">2020-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-30 15:24:49" itemprop="dateModified" datetime="2020-11-30T15:24:49+08:00">2020-11-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/django-rest-framework/" itemprop="url" rel="index"><span itemprop="name">django rest_framework</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>前面我们介绍了DRF的request的二次封装,解析模块,认证模块,权限模块,频率控制模块跟版本控制模块</p>
<p>接下来我们了解一下序列化器,分页,路由,渲染器</p>
<a id="more"></a>
<h2 id="序列化器"><a href="#序列化器" class="headerlink" title="序列化器"></a>序列化器</h2><h3 id="序列化数据"><a href="#序列化数据" class="headerlink" title="序列化数据"></a>序列化数据</h3><p>在<code>RESTful</code>规范中,我们前后端一般都是通过<code>json</code>来传递数据的.</p>
<p>所以我们给前端提供的API基本都需要序列化成<code>json</code>字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 获取数据库中的数据</span></span><br><span class="line">        users = UserInfo.objects.all()</span><br><span class="line">        <span class="comment"># 因为获取到的数据是queryset,我们必须通过.values+list来转化</span></span><br><span class="line">        result = json.dumps(list(users.values(<span class="string">'id'</span>,<span class="string">'username'</span>,<span class="string">'password'</span>)))</span><br><span class="line">        <span class="keyword">return</span> Response(result)</span><br></pre></td></tr></table></figure>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200615162415065.png" alt="image-20200615162415065"></p>
<h3 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h3><p>在<code>drf</code>中,也为我们提供了序列化<code>serializers</code></p>
<p>这个<code>serializers</code> 与<code>django</code>的<code>form</code>类似</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo</span><br><span class="line"><span class="comment"># 导入serializers</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="comment"># 自定义一个类,继承serializers.Serializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="comment"># 数据库中的字段</span></span><br><span class="line">    id = serializers.IntegerField()</span><br><span class="line">    username = serializers.CharField()</span><br><span class="line">    password = serializers.CharField()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        users = UserInfo.objects.all()</span><br><span class="line">        <span class="comment"># 实例化这个类,并传入instance=users</span></span><br><span class="line">        <span class="comment"># many=True表示多条数据,如果是一条数据的时候many=False</span></span><br><span class="line">        ser = UserinforSerializers(instance=users,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回ser.data</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200615162415065.png" alt="image-20200615162415065"></p>
<p>是不是与<code>django的form</code>类似,所以我们猜测,他也会有类似<code>modelForm</code>一样的类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo</span><br><span class="line"><span class="comment"># 导入serializers</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="comment"># 自定义一个类,继承serializers.ModelSerializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># 也可以获取字段</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        users = UserInfo.objects.all()</span><br><span class="line">        <span class="comment"># 实例化这个类,并传入instance=users</span></span><br><span class="line">        <span class="comment"># many=True表示多条数据,如果是一条数据的时候many=False</span></span><br><span class="line">        ser = UserinforSerializers(instance=users,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回ser.data</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<p>是不是与我们的<code>ModelForm</code>类似</p>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200615171020763.png" alt="image-20200615171020763"></p>
<p>可以看到我们获取的数据,是把所有<code>Userinfo</code>的表里的数据都获取了,</p>
<p>像<code>group</code>中我们获取的是<code>id</code> 而不是我们希望得到的组名,我们可以这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="comment"># 重新定义一个字段</span></span><br><span class="line">    group = serializers.CharField(source=<span class="string">'group.name'</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200615172017569.png" alt="image-20200615172017569"></p>
<h3 id="SerializerMethodField"><a href="#SerializerMethodField" class="headerlink" title="SerializerMethodField"></a><code>SerializerMethodField</code></h3><p>像<code>roles</code>这样多对多的我们需要怎么取呢?</p>
<p>我们可以用<code>serializers.SerializerMethodField</code>自定义显示字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="comment"># 自定义一个类,继承serializers.ModelSerializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="comment"># 重新定义一个字段</span></span><br><span class="line">    group = serializers.CharField(source=<span class="string">'group.name'</span>)</span><br><span class="line">    roles = serializers.SerializerMethodField()</span><br><span class="line">    <span class="comment"># 自定义显示的函数,以get_开头+自定义字段名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span><span class="params">(self,row)</span>:</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> row.roles.all():</span><br><span class="line">            result.append(&#123;</span><br><span class="line">                <span class="string">'name'</span>:i.name,</span><br><span class="line">                <span class="string">'id'</span>:i.id</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200615200917320.png" alt="image-20200615200917320"></p>
<p>这样我们就自定义显示了多对多关系</p>
<h3 id="深度控制"><a href="#深度控制" class="headerlink" title="深度控制"></a>深度控制</h3><p>当然你还会嫌这个太麻烦,所以<code>drf</code>也帮我们完成了多对多或者更深层的关系<code>depth = 1</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="comment"># 自定义一个类,继承serializers.ModelSerializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br><span class="line">        <span class="comment"># 深度,只要加了这个,就会自动帮我们去查找这个字段的所有关联对象,默认为0,建议1-10,个人建议不要超过3层</span></span><br><span class="line">        depth = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200615204626908.png" alt="image-20200615204626908"></p>
<p>也是可以取出来的,接下来我们对源码进行简单的分析.</p>
<h3 id="序列化源码解析"><a href="#序列化源码解析" class="headerlink" title="序列化源码解析"></a>序列化源码解析</h3><p>我们从<code>ModelSerializer</code>类入手,发现这个类没有<code>__init__</code>方法,我们往上找,<code>Serializer</code>也没有,再往上找<code>BaseSerializer</code>我们在<code>BaseSerializer</code>中发现了<code>__init__</code>方法,并且我们看到还有一个<code>__new__</code>方法,我们知道在构造方法之前都是调用,<code>__new__</code>方法的,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">       <span class="comment"># We override this method in order to automagically create</span></span><br><span class="line">       <span class="comment"># `ListSerializer` classes instead when `many=True` is set.</span></span><br><span class="line">       <span class="comment"># 获取many参数</span></span><br><span class="line">       <span class="keyword">if</span> kwargs.pop(<span class="string">'many'</span>, <span class="literal">False</span>):</span><br><span class="line">           <span class="comment"># 如果为True则执行many_init</span></span><br><span class="line">           <span class="keyword">return</span> cls.many_init(*args, **kwargs)</span><br><span class="line">       <span class="comment"># False则执行__init__方法</span></span><br><span class="line">       <span class="keyword">return</span> super().__new__(cls, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<p><code>many_init</code>中其实是调用了<code>ListSerializer</code>类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">many_init</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">    allow_empty = kwargs.pop(<span class="string">'allow_empty'</span>, <span class="literal">None</span>)</span><br><span class="line">    child_serializer = cls(*args, **kwargs)</span><br><span class="line">    list_kwargs = &#123;</span><br><span class="line">        <span class="string">'child'</span>: child_serializer,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> allow_empty <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        list_kwargs[<span class="string">'allow_empty'</span>] = allow_empty</span><br><span class="line">    list_kwargs.update(&#123;</span><br><span class="line">        key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items()</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> LIST_SERIALIZER_KWARGS</span><br><span class="line">    &#125;)</span><br><span class="line">    meta = getattr(cls, <span class="string">'Meta'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># 调用ListSerializer类</span></span><br><span class="line">    list_serializer_class = getattr(meta, <span class="string">'list_serializer_class'</span>, ListSerializer)</span><br><span class="line">    <span class="keyword">return</span> list_serializer_class(*args, **list_kwargs)</span><br></pre></td></tr></table></figure>
<p>如果为<code>False</code>其实是调用了<code>Serializer</code>类</p>
<p>接下来我们看一下<code>return Response(ser.data)</code>中的<code>ser.data</code>做了什么</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">    ret = super().data</span><br><span class="line">    <span class="keyword">return</span> ReturnDict(ret, serializer=self)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再找他的父类中的data</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(self, <span class="string">'initial_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):</span><br><span class="line">            msg = (</span><br><span class="line">                <span class="string">'When a serializer is passed a `data` keyword argument you '</span></span><br><span class="line">                <span class="string">'must call `.is_valid()` before attempting to access the '</span></span><br><span class="line">                <span class="string">'serialized `.data` representation.\n'</span></span><br><span class="line">                <span class="string">'You should either call `.is_valid()` first, '</span></span><br><span class="line">                <span class="string">'or access `.initial_data` instead.'</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(msg)</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_data'</span>):</span><br><span class="line">            <span class="keyword">if</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="literal">None</span>):</span><br><span class="line">                <span class="comment"># 调用self.to_representation,应该去各自的类中一层一层往上找</span></span><br><span class="line">                <span class="comment"># Serializer类,跟ListSerializer中</span></span><br><span class="line">                self._data = self.to_representation(self.instance)</span><br><span class="line">            <span class="keyword">elif</span> hasattr(self, <span class="string">'_validated_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="literal">None</span>):</span><br><span class="line">                self._data = self.to_representation(self.validated_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._data = self.get_initial()</span><br><span class="line">        <span class="keyword">return</span> self._data</span><br></pre></td></tr></table></figure>
<p><code>Serializer类中</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_representation</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Object instance -&gt; Dict of primitive datatypes.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 创建一个有序字典</span></span><br><span class="line">    ret = OrderedDict()</span><br><span class="line">    <span class="comment"># 获取Serializer中的所有字段</span></span><br><span class="line">    fields = self._readable_fields</span><br><span class="line">	<span class="comment"># 循环每个字段</span></span><br><span class="line">    <span class="keyword">for</span> field <span class="keyword">in</span> fields:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取每个字段对应的get_attribute中的对象</span></span><br><span class="line">            <span class="comment"># instance是传入的model对象实例</span></span><br><span class="line">            attribute = field.get_attribute(instance)</span><br><span class="line">        <span class="keyword">except</span> SkipField:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># We skip `to_representation` for `None` values so that fields do</span></span><br><span class="line">        <span class="comment"># not have to explicitly deal with that case.</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># For related fields with `use_pk_only_optimization` we need to</span></span><br><span class="line">        <span class="comment"># resolve the pk value.</span></span><br><span class="line">        check_for_none = attribute.pk <span class="keyword">if</span> isinstance(attribute, PKOnlyObject) <span class="keyword">else</span> attribute</span><br><span class="line">        <span class="keyword">if</span> check_for_none <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            ret[field.field_name] = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 这里是把获取的对象,再去每个字段的对象里获取to_representation</span></span><br><span class="line">            ret[field.field_name] = field.to_representation(attribute)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>
<p>从<code>get_attribute</code>找到<code>Field</code>类中的<code>get_attribute</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_attribute</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        if self.source == '*':</span></span><br><span class="line"><span class="string">            self.source_attrs = []</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            self.source_attrs = self.source.split('.')</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 这里的source_attrs就是上面的self.source.split('.')</span></span><br><span class="line">        <span class="keyword">return</span> get_attribute(instance, self.source_attrs)</span><br></pre></td></tr></table></figure>
<p>然后我们再点进去查看<code>get_attribute</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_attribute</span><span class="params">(instance, attrs)</span>:</span></span><br><span class="line">    <span class="comment"># 循环刚才的source_attrs列表</span></span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 如果有直接赋值</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(instance, Mapping):</span><br><span class="line">                instance = instance[attr]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 如果是group.title这样的 再赋值一次再循环</span></span><br><span class="line">                instance = getattr(instance, attr)</span><br><span class="line">        <span class="keyword">except</span> ObjectDoesNotExist:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 如果是可调用的callable</span></span><br><span class="line">        <span class="keyword">if</span> is_simple_callable(instance):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 加括号,相当于调用</span></span><br><span class="line">                instance = instance()</span><br><span class="line">            <span class="keyword">except</span> (AttributeError, KeyError) <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="comment"># If we raised an Attribute or KeyError here it'd get treated</span></span><br><span class="line">                <span class="comment"># as an omitted field in `Field.get_attribute()`. Instead we</span></span><br><span class="line">                <span class="comment"># raise a ValueError to ensure the exception is not masked.</span></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">'Exception raised in callable attribute "&#123;&#125;"; original exception was: &#123;&#125;'</span>.format(attr, exc))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>
<p>这就是序列化器的基本流程了</p>
<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><h4 id="请求数据校验"><a href="#请求数据校验" class="headerlink" title="请求数据校验"></a>请求数据校验</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo</span><br><span class="line"><span class="comment"># 导入serializers</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="comment"># 自定义一个类,继承serializers.ModelSerializer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        data = request.data</span><br><span class="line">        print(data) <span class="comment"># &#123;'username': 1, 'password': 123&#125;</span></span><br><span class="line">        <span class="comment"># 这里就不是instance 而是data了</span></span><br><span class="line">        ser = UserinforSerializers(data=data)</span><br><span class="line">        <span class="comment"># 校验</span></span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            <span class="comment"># 保存</span></span><br><span class="line">            ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(<span class="string">'ok'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(ser.errors)</span><br></pre></td></tr></table></figure>
<p>这样一看 是不是这玩意特别像<code>ModelForm</code>所以也会有跟自定义校验的钩子函数,有全局跟局部</p>
<h4 id="自定义校验"><a href="#自定义校验" class="headerlink" title="自定义校验"></a>自定义校验</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 局部校验的钩子函数validate_+字段名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_username</span><span class="params">(self,value)</span>:</span></span><br><span class="line">        print(<span class="string">'value'</span>,value)</span><br><span class="line">        <span class="comment"># value 1</span></span><br><span class="line">        <span class="comment"># 自定义规则</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="comment"># 全局钩子函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, attrs)</span>:</span></span><br><span class="line">        print(<span class="string">'attrs'</span>,attrs)</span><br><span class="line">        <span class="comment"># attrs: OrderedDict([('username', '1'), ('password', '123')]) </span></span><br><span class="line">        <span class="comment"># attr.get(字段名)</span></span><br><span class="line">        <span class="keyword">return</span> attrs</span><br></pre></td></tr></table></figure>
<p>查看源码,我们可以从<code>is_valid</code>入手</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_valid</span><span class="params">(self, raise_exception=False)</span>:</span></span><br><span class="line">    <span class="comment"># 断言不管</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 执行self.run_validation,需要从我们自己的类出发开始找,没有再找父类的</span></span><br><span class="line">            self._validated_data = self.run_validation(self.initial_data)</span><br><span class="line">        <span class="keyword">except</span> ValidationError <span class="keyword">as</span> exc:</span><br><span class="line">            self._validated_data = &#123;&#125;</span><br><span class="line">            self._errors = exc.detail</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._errors = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._errors <span class="keyword">and</span> raise_exception:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(self.errors)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> bool(self._errors)</span><br></pre></td></tr></table></figure>
<p>我们在<code>Serializer</code>类中找到了<code>to_internal_value</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span><span class="params">(self, data)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Dict of native values &lt;- Dict of primitive datatypes.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(data, Mapping):</span><br><span class="line">        message = self.error_messages[<span class="string">'invalid'</span>].format(</span><br><span class="line">            datatype=type(data).__name__</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(&#123;</span><br><span class="line">            api_settings.NON_FIELD_ERRORS_KEY: [message]</span><br><span class="line">        &#125;, code=<span class="string">'invalid'</span>)</span><br><span class="line"></span><br><span class="line">    ret = OrderedDict()</span><br><span class="line">    errors = OrderedDict()</span><br><span class="line">    fields = self._writable_fields</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> field <span class="keyword">in</span> fields:</span><br><span class="line">        <span class="comment"># 这里就是局部钩子 validate_ + 字段名</span></span><br><span class="line">        validate_method = getattr(self, <span class="string">'validate_'</span> + field.field_name, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 获取value 传入的参数</span></span><br><span class="line">        primitive_value = field.get_value(data)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#先做drf 提供的内置字段的校验,返回校验通过的值</span></span><br><span class="line">            validated_value = field.run_validation(primitive_value)</span><br><span class="line">            <span class="comment"># 钩子函数的校验</span></span><br><span class="line">            <span class="keyword">if</span> validate_method <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">               <span class="comment"># 如果不为空,则执行自定义的钩子函数</span></span><br><span class="line">                validated_value = validate_method(validated_value)</span><br><span class="line">        <span class="keyword">except</span> ValidationError <span class="keyword">as</span> exc:</span><br><span class="line">            errors[field.field_name] = exc.detail</span><br><span class="line">        <span class="keyword">except</span> DjangoValidationError <span class="keyword">as</span> exc:</span><br><span class="line">            errors[field.field_name] = get_error_detail(exc)</span><br><span class="line">        <span class="keyword">except</span> SkipField:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            set_value(ret, field.source_attrs, validated_value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> errors:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(errors)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><p><code>DRF</code>内置了三种分页<code>PageNumberPagination,CursorPagination,LimitOffsetPagination</code></p>
<p><code>PageNumberPagination</code>源码: 可以看到其实调用的是<code>django自身的Paginator</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageNumberPagination</span><span class="params">(BasePagination)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A simple page number based style that supports page numbers as</span></span><br><span class="line"><span class="string">    query parameters. For example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    http://api.example.org/accounts/?page=4</span></span><br><span class="line"><span class="string">    http://api.example.org/accounts/?page=4&amp;page_size=100</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># The default page size.</span></span><br><span class="line">    <span class="comment"># Defaults to `None`, meaning pagination is disabled.</span></span><br><span class="line">    page_size = api_settings.PAGE_SIZE</span><br><span class="line">	<span class="comment"># DjangoPaginator 其实是调用的django自身的分页</span></span><br><span class="line">    django_paginator_class = DjangoPaginator</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Client can control the page using this query parameter.</span></span><br><span class="line">    <span class="comment"># 默认参数</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span></span><br><span class="line">    page_query_description = _(<span class="string">'A page number within the paginated result set.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Client can control the page size using this query parameter.</span></span><br><span class="line">    <span class="comment"># Default is 'None'. Set to eg 'page_size' to enable usage.</span></span><br><span class="line">    <span class="comment"># 默认page_size参数</span></span><br><span class="line">    page_size_query_param = <span class="literal">None</span></span><br><span class="line">    page_size_query_description = _(<span class="string">'Number of results to return per page.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set to an integer to limit the maximum page size the client may request.</span></span><br><span class="line">    <span class="comment"># Only relevant if 'page_size_query_param' has also been set.</span></span><br><span class="line">    <span class="comment"># 最大page_size</span></span><br><span class="line">    max_page_size = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    last_page_strings = (<span class="string">'last'</span>,)</span><br><span class="line"></span><br><span class="line">    template = <span class="string">'rest_framework/pagination/numbers.html'</span></span><br><span class="line"></span><br><span class="line">    invalid_page_message = _(<span class="string">'Invalid page.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span><span class="params">(self, queryset, request, view=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Paginate a queryset if required, either returning a</span></span><br><span class="line"><span class="string">        page object, or `None` if pagination is not configured for this view.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        page_size = self.get_page_size(request)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> page_size:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">	   <span class="comment">#这里就是调用的 django_paginator_class = DjangoPaginator </span></span><br><span class="line">        paginator = self.django_paginator_class(queryset, page_size)</span><br><span class="line">        page_number = request.query_params.get(self.page_query_param, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> page_number <span class="keyword">in</span> self.last_page_strings:</span><br><span class="line">            page_number = paginator.num_pages</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.page = paginator.page(page_number)</span><br><span class="line">        <span class="keyword">except</span> InvalidPage <span class="keyword">as</span> exc:</span><br><span class="line">            msg = self.invalid_page_message.format(</span><br><span class="line">                page_number=page_number, message=str(exc)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span> NotFound(msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> paginator.num_pages &gt; <span class="number">1</span> <span class="keyword">and</span> self.template <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># The browsable API should display pagination controls.</span></span><br><span class="line">            self.display_page_controls = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        self.request = request</span><br><span class="line">        <span class="keyword">return</span> list(self.page)</span><br></pre></td></tr></table></figure>
<p><code>LimitOffsetPagination</code>源码: 其实就是列表切片</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LimitOffsetPagination</span><span class="params">(BasePagination)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A limit/offset based style. For example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    http://api.example.org/accounts/?limit=100</span></span><br><span class="line"><span class="string">    http://api.example.org/accounts/?offset=400&amp;limit=100</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    default_limit = api_settings.PAGE_SIZE</span><br><span class="line">    limit_query_param = <span class="string">'limit'</span></span><br><span class="line">    limit_query_description = _(<span class="string">'Number of results to return per page.'</span>)</span><br><span class="line">    offset_query_param = <span class="string">'offset'</span></span><br><span class="line">    offset_query_description = _(<span class="string">'The initial index from which to return the results.'</span>)</span><br><span class="line">    max_limit = <span class="literal">None</span></span><br><span class="line">    template = <span class="string">'rest_framework/pagination/numbers.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span><span class="params">(self, queryset, request, view=None)</span>:</span></span><br><span class="line">        self.count = self.get_count(queryset)</span><br><span class="line">        self.limit = self.get_limit(request)</span><br><span class="line">        <span class="keyword">if</span> self.limit <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.offset = self.get_offset(request)</span><br><span class="line">        self.request = request</span><br><span class="line">        <span class="keyword">if</span> self.count &gt; self.limit <span class="keyword">and</span> self.template <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.display_page_controls = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.count == <span class="number">0</span> <span class="keyword">or</span> self.offset &gt; self.count:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="comment"># 返回切片</span></span><br><span class="line">        <span class="keyword">return</span> list(queryset[self.offset:self.offset + self.limit])</span><br></pre></td></tr></table></figure>
<p><code>CursorPagination</code>游标加密分页,这个分页需要排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CursorPagination</span><span class="params">(BasePagination)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    The cursor pagination implementation is necessarily complex.</span></span><br><span class="line"><span class="string">    For an overview of the position/offset style we use, see this post:</span></span><br><span class="line"><span class="string">    https://cra.mr/2011/03/08/building-cursors-for-the-disqus-api</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    cursor_query_param = <span class="string">'cursor'</span></span><br><span class="line">    cursor_query_description = _(<span class="string">'The pagination cursor value.'</span>)</span><br><span class="line">    page_size = api_settings.PAGE_SIZE</span><br><span class="line">    invalid_cursor_message = _(<span class="string">'Invalid cursor'</span>)</span><br><span class="line">    ordering = <span class="string">'-created'</span></span><br><span class="line">    template = <span class="string">'rest_framework/pagination/previous_and_next.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Client can control the page size using this query parameter.</span></span><br><span class="line">    <span class="comment"># Default is 'None'. Set to eg 'page_size' to enable usage.</span></span><br><span class="line">    page_size_query_param = <span class="literal">None</span></span><br><span class="line">    page_size_query_description = _(<span class="string">'Number of results to return per page.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set to an integer to limit the maximum page size the client may request.</span></span><br><span class="line">    <span class="comment"># Only relevant if 'page_size_query_param' has also been set.</span></span><br><span class="line">    max_page_size = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The offset in the cursor is used in situations where we have a</span></span><br><span class="line">    <span class="comment"># nearly-unique index. (Eg millisecond precision creation timestamps)</span></span><br><span class="line">    <span class="comment"># We guard against malicious users attempting to cause expensive database</span></span><br><span class="line">    <span class="comment"># queries, by having a hard cap on the maximum possible size of the offset.</span></span><br><span class="line">    offset_cutoff = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span><span class="params">(self, queryset, request, view=None)</span>:</span></span><br><span class="line">        self.page_size = self.get_page_size(request)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.page_size:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.base_url = request.build_absolute_uri()</span><br><span class="line">        self.ordering = self.get_ordering(request, queryset, view)</span><br><span class="line"></span><br><span class="line">        self.cursor = self.decode_cursor(request)</span><br><span class="line">        <span class="keyword">if</span> self.cursor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            (offset, reverse, current_position) = (<span class="number">0</span>, <span class="literal">False</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            (offset, reverse, current_position) = self.cursor</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Cursor pagination always enforces an ordering.</span></span><br><span class="line">        <span class="keyword">if</span> reverse:</span><br><span class="line">            queryset = queryset.order_by(*_reverse_ordering(self.ordering))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queryset = queryset.order_by(*self.ordering)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If we have a cursor with a fixed position then filter by that.</span></span><br><span class="line">        <span class="keyword">if</span> current_position <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            order = self.ordering[<span class="number">0</span>]</span><br><span class="line">            is_reversed = order.startswith(<span class="string">'-'</span>)</span><br><span class="line">            order_attr = order.lstrip(<span class="string">'-'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Test for: (cursor reversed) XOR (queryset reversed)</span></span><br><span class="line">            <span class="comment"># 获取分页是上一页还是下一页</span></span><br><span class="line">            <span class="keyword">if</span> self.cursor.reverse != is_reversed:</span><br><span class="line">                kwargs = &#123;order_attr + <span class="string">'__lt'</span>: current_position&#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                kwargs = &#123;order_attr + <span class="string">'__gt'</span>: current_position&#125;</span><br><span class="line"></span><br><span class="line">            queryset = queryset.filter(**kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If we have an offset cursor then offset the entire page by that amount.</span></span><br><span class="line">        <span class="comment"># We also always fetch an extra item in order to determine if there is a</span></span><br><span class="line">        <span class="comment"># page following on from this one.</span></span><br><span class="line">        results = list(queryset[offset:offset + self.page_size + <span class="number">1</span>])</span><br><span class="line">        self.page = list(results[:self.page_size])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Determine the position of the final item following the page.</span></span><br><span class="line">        <span class="keyword">if</span> len(results) &gt; len(self.page):</span><br><span class="line">            has_following_position = <span class="literal">True</span></span><br><span class="line">            following_position = self._get_position_from_instance(results[<span class="number">-1</span>], self.ordering)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            has_following_position = <span class="literal">False</span></span><br><span class="line">            following_position = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> reverse:</span><br><span class="line">            <span class="comment"># If we have a reverse queryset, then the query ordering was in reverse</span></span><br><span class="line">            <span class="comment"># so we need to reverse the items again before returning them to the user.</span></span><br><span class="line">            self.page = list(reversed(self.page))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Determine next and previous positions for reverse cursors.</span></span><br><span class="line">            self.has_next = (current_position <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>) <span class="keyword">or</span> (offset &gt; <span class="number">0</span>)</span><br><span class="line">            self.has_previous = has_following_position</span><br><span class="line">            <span class="keyword">if</span> self.has_next:</span><br><span class="line">                self.next_position = current_position</span><br><span class="line">            <span class="keyword">if</span> self.has_previous:</span><br><span class="line">                self.previous_position = following_position</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Determine next and previous positions for forward cursors.</span></span><br><span class="line">            self.has_next = has_following_position</span><br><span class="line">            self.has_previous = (current_position <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>) <span class="keyword">or</span> (offset &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> self.has_next:</span><br><span class="line">                self.next_position = following_position</span><br><span class="line">            <span class="keyword">if</span> self.has_previous:</span><br><span class="line">                self.previous_position = current_position</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Display page controls in the browsable API if there is more</span></span><br><span class="line">        <span class="comment"># than one page.</span></span><br><span class="line">        <span class="keyword">if</span> (self.has_previous <span class="keyword">or</span> self.has_next) <span class="keyword">and</span> self.template <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.display_page_controls = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.page</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination,CursorPagination,LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        users = UserInfo.objects.all()</span><br><span class="line">        <span class="comment"># 实例化这个类,并传入instance=users</span></span><br><span class="line">        <span class="comment"># many=True表示多条数据,如果是一条数据的时候many=False</span></span><br><span class="line">        pagination = PageNumberPagination()</span><br><span class="line">        pagination.page_size=<span class="number">1</span></span><br><span class="line">        p = pagination.paginate_queryset(queryset=users,request=request)</span><br><span class="line">        ser = UserinforSerializers(instance=p,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回ser.data</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<p>当然我们也可以自定义一个类然后继承上面的内置类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPagination</span><span class="params">(PageNumberPagination)</span>:</span></span><br><span class="line">    <span class="comment"># 分页长度</span></span><br><span class="line">    page_size = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 分页参数 ?size=2 来改变分页长度</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span></span><br><span class="line">    <span class="comment"># 最大分页长度</span></span><br><span class="line">    max_page_size = <span class="number">10</span></span><br><span class="line">    <span class="comment"># Client can control the page using this query parameter.</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        users = UserInfo.objects.all()</span><br><span class="line">        <span class="comment"># 继承我们自定义的类就可以了.</span></span><br><span class="line">        pagination = MyPagination()</span><br><span class="line">        p = pagination.paginate_queryset(queryset=users,request=request)</span><br><span class="line">        ser = UserinforSerializers(instance=p,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<p><code>LimitOffsetPagination</code>类似,不过传参的时候是<code>?offset=0&amp;limit=3</code> <code>offset</code>是从0开始</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPagination</span><span class="params">(LimitOffsetPagination)</span>:</span></span><br><span class="line">    <span class="comment"># 相当于size</span></span><br><span class="line">    default_limit = <span class="number">1</span></span><br><span class="line">    limit_query_param = <span class="string">'limit'</span></span><br><span class="line">    max_limit = <span class="number">3</span></span><br><span class="line">    offset_query_param = <span class="string">'offset'</span></span><br></pre></td></tr></table></figure>
<p><code>CursorPagination</code>: 只有为我们提供了上一页下一页,必须要排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPagination</span><span class="params">(CursorPagination)</span>:</span></span><br><span class="line">    <span class="comment"># 当前页游标</span></span><br><span class="line">    cursor_query_param = <span class="string">'cursor'</span></span><br><span class="line">    <span class="comment"># 指定分页个数</span></span><br><span class="line">    page_size = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 指定排序</span></span><br><span class="line">    ordering = <span class="string">'-id'</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span></span><br><span class="line">    max_page_size = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        users = UserInfo.objects.all()</span><br><span class="line">        pagination = MyPagination()</span><br><span class="line">        p = pagination.paginate_queryset(queryset=users,request=request)</span><br><span class="line">        ser = UserinforSerializers(instance=p,many=<span class="literal">True</span>)</span><br><span class="line">   		<span class="comment"># 由于是加密的游标所以,必须提供内置的方法来生成Response</span></span><br><span class="line">        <span class="keyword">return</span> pagination.get_paginated_response(ser.data)</span><br><span class="line">        <span class="comment"># return Response(ser.data)</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/django-rest_framework源码解析之序列化器,分页,路由,渲染器/image-20200616101431910.png" alt="image-20200616101431910"></p>
<h2 id="视图类"><a href="#视图类" class="headerlink" title="视图类"></a>视图类</h2><p>我们现在都是继承于<code>APIView</code> ,那么<code>drf</code>是否有为我们提供更方便的视图类呢?</p>
<p>当然是有的.</p>
<p><code>GenericAPIView</code>:继承自<strong>APIView</strong>，增加了对于列表视图和详情视图可能用到的通用支持方法。通常使用时，可搭配一个或多个Mixin扩展类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span><span class="params">(views.APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 列表视图的查询集</span></span><br><span class="line">    queryset = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 视图使用的序列化器</span></span><br><span class="line">    serializer_class = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If you want to use object lookups other than pk, set 'lookup_field'.</span></span><br><span class="line">    <span class="comment"># For more complex lookup requirements override `get_object()`.</span></span><br><span class="line">    <span class="comment"># 关键字查询</span></span><br><span class="line">    lookup_field = <span class="string">'pk'</span></span><br><span class="line">    lookup_url_kwarg = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The filter backend classes to use for queryset filtering</span></span><br><span class="line">    <span class="comment"># 筛选控制</span></span><br><span class="line">    filter_backends = api_settings.DEFAULT_FILTER_BACKENDS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The style to use for queryset pagination.</span></span><br><span class="line">    <span class="comment"># 分页</span></span><br><span class="line">    pagination_class = api_settings.DEFAULT_PAGINATION_CLASS</span><br><span class="line">	<span class="comment"># 获取视图对应的查询集</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># 返回单个对象   </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># 序列化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">    <span class="comment"># 获取序列化的类</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="comment"># 序列化内容</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_context</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># 进行筛选</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter_queryset</span><span class="params">(self, queryset)</span>:</span></span><br><span class="line">    <span class="comment"># 获取分页类</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginator</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="comment"># 分页</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span><span class="params">(self, queryset)</span>:</span></span><br><span class="line">    <span class="comment"># 返回分页 response</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paginated_response</span><span class="params">(self, data)</span></span></span><br></pre></td></tr></table></figure>
<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo</span><br><span class="line"><span class="comment"># 导入serializers</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="comment"># 自定义一个类,继承serializers.ModelSerializer</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination,CursorPagination,LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinforSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># 关联数据库</span></span><br><span class="line">        model=UserInfo</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id','username','password']</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPagination</span><span class="params">(PageNumberPagination)</span>:</span></span><br><span class="line">    page_size = <span class="number">1</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(GenericAPIView)</span>:</span></span><br><span class="line">    <span class="comment"># 定义视图数据集</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    <span class="comment"># 分页类</span></span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    <span class="comment"># 序列化类</span></span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 获取数据</span></span><br><span class="line">        ret = self.get_queryset()</span><br><span class="line">        <span class="comment"># 获取分页</span></span><br><span class="line">        p = self.paginate_queryset(ret)</span><br><span class="line">        <span class="comment"># 序列化</span></span><br><span class="line">        ser = self.get_serializer(p,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回数据</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<h3 id="视图扩展类"><a href="#视图扩展类" class="headerlink" title="视图扩展类"></a>视图扩展类</h3><p><code>ListModelMixin</code> :快速实现列表视图</p>
<p>源码:就是内部帮我们实现了上面的操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    List a queryset.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        queryset = self.filter_queryset(self.get_queryset())</span><br><span class="line">		</span><br><span class="line">        page = self.paginate_queryset(queryset)</span><br><span class="line">        <span class="keyword">if</span> page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            serializer = self.get_serializer(page, many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> self.get_paginated_response(serializer.data)</span><br><span class="line"></span><br><span class="line">        serializer = self.get_serializer(queryset, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(ListModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        data = self.list(request)</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p><code>CreateModelMixin</code>:实现新增</p>
<p>源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 帮我们实现了新增</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        <span class="comment"># raise_exception=True 没有通过验证就直接报错.</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span><span class="params">(self, serializer)</span>:</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])&#125;</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin,CreateModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(CreateModelMixin,ListModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        data = self.list(request)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request=request)</span><br></pre></td></tr></table></figure>
<p><code>RetrieveModelMixin</code>:获取单个对象</p>
<p>源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetrieveModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Retrieve a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retrieve</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>
<p>需要新增URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'api/&lt;version&gt;/user/'</span>,UserinfoView.as_view()),</span><br><span class="line"><span class="comment">#新增</span></span><br><span class="line">path(<span class="string">'api/&lt;version&gt;/user/&lt;pk&gt;/'</span>,UserinfoView.as_view())</span><br></pre></td></tr></table></figure>
<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin,CreateModelMixin,RetrieveModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(CreateModelMixin,ListModelMixin,RetrieveModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>,<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> pk:</span><br><span class="line">            data = self.retrieve(request)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = self.list(request)</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p><code>UpdateModelMixin</code>:更新</p>
<p>源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Update a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        partial = kwargs.pop(<span class="string">'partial'</span>, <span class="literal">False</span>)</span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        serializer = self.get_serializer(instance, data=request.data, partial=partial)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        self.perform_update(serializer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> getattr(instance, <span class="string">'_prefetched_objects_cache'</span>, <span class="literal">None</span>):</span><br><span class="line">            <span class="comment"># If 'prefetch_related' has been applied to a queryset, we need to</span></span><br><span class="line">            <span class="comment"># forcibly invalidate the prefetch cache on the instance.</span></span><br><span class="line">            instance._prefetched_objects_cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span><span class="params">(self, serializer)</span>:</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partial_update</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        kwargs[<span class="string">'partial'</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin,CreateModelMixin,RetrieveModelMixin,UpdateModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(CreateModelMixin,ListModelMixin,RetrieveModelMixin,UpdateModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>,<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> pk:</span><br><span class="line">            data = self.retrieve(request)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = self.list(request)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request=request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request=request,*args,**kwargs)</span><br></pre></td></tr></table></figure>
<p><code>DestroyModelMixin</code> :删除对象</p>
<p>源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DestroyModelMixin</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Destroy a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">destroy</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        self.perform_destroy(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_destroy</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">        instance.delete()</span><br></pre></td></tr></table></figure>
<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> ListModelMixin,CreateModelMixin,RetrieveModelMixin,UpdateModelMixin,DestroyModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(DestroyModelMixin,CreateModelMixin,ListModelMixin,RetrieveModelMixin,UpdateModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        pk = kwargs.get(<span class="string">'pk'</span>,<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> pk:</span><br><span class="line">            data = self.retrieve(request)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = self.list(request)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request=request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request=request,*args,**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request=request,*args,**kwargs)</span><br></pre></td></tr></table></figure>
<p><code>GenericViewSet</code> 继承了<code>ViewSetMixin, generics.GenericAPIView</code></p>
<p><code>ViewSetMixin</code>中重写了<code>as_view</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  &#123;'get': 'list', 'post': 'create'&#125;</span></span><br><span class="line">    <span class="keyword">for</span> method, action <span class="keyword">in</span> actions.items():</span><br><span class="line">        	   <span class="comment">#获取list方法,</span></span><br><span class="line">                handler = getattr(self, action)</span><br><span class="line">                <span class="comment"># 把list设置给self</span></span><br><span class="line">                setattr(self, method, handler)</span><br></pre></td></tr></table></figure>
<p>例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'get'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'list'</span>)</span><br><span class="line"></span><br><span class="line">a = &#123;<span class="string">'get'</span>:<span class="string">'list'</span>&#125;</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> a.items():</span><br><span class="line">    j = getattr(Foo,<span class="string">'list'</span>)</span><br><span class="line">    setattr(Foo,<span class="string">'get'</span>,j)</span><br><span class="line">f = Foo()</span><br><span class="line">f.get()</span><br><span class="line">&gt;&gt;list</span><br></pre></td></tr></table></figure>
<p>所以我们就可以用<code>ModelViewSet</code> + <code>url</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span><span class="params">(mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   GenericViewSet)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A viewset that provides default `create()`, `retrieve()`, `update()`,</span></span><br><span class="line"><span class="string">    `partial_update()`, `destroy()` and `list()` actions.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p><code>url.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'api/&lt;version&gt;/user/'</span>,UserinfoView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'list'</span>,<span class="string">'post'</span>:<span class="string">'create'</span>&#125;)),</span><br><span class="line">   path(<span class="string">'api/&lt;version&gt;/user/&lt;pk&gt;/'</span>,UserinfoView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'retrieve'</span>,<span class="string">'put'</span>:<span class="string">'update'</span>,<span class="string">'delete'</span>:<span class="string">'destroy'</span>&#125;))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    <span class="comment"># def get(self,request,*args,**kwargs):</span></span><br><span class="line">    <span class="comment">#     return</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br></pre></td></tr></table></figure>
<p>这样就可以实现增删改查了.</p>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>当然如果嫌之前写的路由太复杂,<code>DRF</code>也为我们提供了路由模块,注意是针对<code>viewset</code></p>
<h3 id="自动生成url"><a href="#自动生成url" class="headerlink" title="自动生成url"></a>自动生成<code>url</code></h3><ul>
<li><code>SimpleRouter</code></li>
<li><code>DefaultRouter</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,include</span><br><span class="line"><span class="keyword">from</span> testdrf.views <span class="keyword">import</span> Test,UserinfoView</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> SimpleRouter</span><br><span class="line">router =SimpleRouter()</span><br><span class="line">router.register(<span class="string">r'user'</span>, UserinfoView,basename=<span class="string">'user'</span>)</span><br><span class="line"><span class="comment"># register(prefix, viewset, base_name)</span></span><br><span class="line"><span class="comment"># prefix 该视图集的路由前缀</span></span><br><span class="line"><span class="comment"># viewset 视图集</span></span><br><span class="line"><span class="comment"># base_name 路由名称的前缀</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">'api/&lt;version&gt;/test/'</span>,Test.as_view()),</span><br><span class="line">    path(<span class="string">'api/&lt;version&gt;/'</span>,include(router.urls))</span><br></pre></td></tr></table></figure>
<p>这样就会帮我们生产两条<code>url</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">api/&lt;version&gt;/ ^user/$ [name=<span class="string">'user-list'</span>]</span><br><span class="line">api/&lt;version&gt;/ ^user/(?P&lt;pk&gt;[^/.]+)/$ [name='user-detail']</span><br></pre></td></tr></table></figure>
<h3 id="视图集中附加action的声明"><a href="#视图集中附加action的声明" class="headerlink" title="视图集中附加action的声明"></a>视图集中附加action的声明</h3><p>在视图集中，如果想要让Router自动帮助我们为自定义的动作生成路由信息，需要使用<code>rest_framework.decorators.action</code>装饰器。</p>
<p>以action装饰器装饰的方法名会作为action动作名，与list、retrieve等同。</p>
<p>action装饰器可以接收两个参数：</p>
<ul>
<li><p><strong>methods</strong>: 声明该action对应的请求方式，列表传递</p>
</li>
<li><p><strong>detail</strong>: 声明该action的路径是否与单一资源对应，及是否是<code>xxx/&lt;pk&gt;/action方法名/</code></p>
</li>
<li><ul>
<li>True 表示路径格式是<code>xxx/&lt;pk&gt;/action方法名/</code></li>
<li>False 表示路径格式是<code>xxx/action方法名/</code></li>
</ul>
</li>
</ul>
<p>如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserinfoView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset = UserInfo.objects.all()</span><br><span class="line">    pagination_class = MyPagination</span><br><span class="line">    serializer_class = UserinforSerializers</span><br><span class="line"></span><br><span class="line"><span class="meta">    @action(methods=['get'], detail=False)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">xxx</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>
<p>则会生成<code>http://127.0.0.1:8000/api/v1/user/xxx/</code>这样的url</p>
<h2 id="渲染器"><a href="#渲染器" class="headerlink" title="渲染器"></a>渲染器</h2><p>最后一个渲染器模块,也是从<code>dispatch</code>出发</p>
<p><code>self.response = self.finalize_response(request, response, *args, **kwargs)</code>从这里进入</p>
<p><code>neg = self.perform_content_negotiation(request, force=True)</code>再进入这里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">perform_content_negotiation</span><span class="params">(self, request, force=False)</span>:</span></span><br><span class="line">       <span class="string">"""</span></span><br><span class="line"><span class="string">       Determine which renderer and media type to use render the response.</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">       <span class="comment"># 获取渲染类</span></span><br><span class="line">       renderers = self.get_renderers()</span><br><span class="line">       conneg = self.get_content_negotiator()</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           <span class="keyword">return</span> conneg.select_renderer(request, renderers, self.format_kwarg)</span><br><span class="line">       <span class="keyword">except</span> Exception:</span><br><span class="line">           <span class="keyword">if</span> force:</span><br><span class="line">               <span class="keyword">return</span> (renderers[<span class="number">0</span>], renderers[<span class="number">0</span>].media_type)</span><br><span class="line">           <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_renderers</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="string">"""</span></span><br><span class="line"><span class="string">       Instantiates and returns the list of renderers that this view can use.</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">       <span class="keyword">return</span> [renderer() <span class="keyword">for</span> renderer <span class="keyword">in</span> self.renderer_classes]</span><br></pre></td></tr></table></figure>
<p>跟其他的一样都是可以配置的.所以我们应该十分熟悉了.</p>
<p><code>drf</code>内置了很多渲染类,我们可以<code>from rest_framework.renderers import BrowsableAPIRenderer</code>进入<code>renderers</code>查看</p>
<p>基本上我们就只会用到<code>BrowsableAPIRenderer</code>跟<code>JSONRenderer</code> 就差不多了</p>
<p>至此我们的<code>drf</code>组件就完结了.</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>万丈高楼平地起,勿在浮沙筑高台</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Tigercoll 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
              <a href="/tags/django/" rel="tag"><i class="fa fa-tag"></i> django</a>
              <a href="/tags/rest-framework/" rel="tag"><i class="fa fa-tag"></i> rest_framework</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/09/django-rest_framework(request)/" rel="prev" title="django rest_framework源码解析(解析模块,认证,权限,频率控制,版本控制)">
      <i class="fa fa-chevron-left"></i> django rest_framework源码解析(解析模块,认证,权限,频率控制,版本控制)
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/06/17/django%E9%85%8D%E7%BD%AE%E7%A6%BB%E7%BA%BF%E8%84%9A%E6%9C%AC/" rel="next" title="django配置离线脚本">
      django配置离线脚本 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zNDY4NC8xMTIyMQ=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#序列化器"><span class="nav-number">1.</span> <span class="nav-text">序列化器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化数据"><span class="nav-number">1.1.</span> <span class="nav-text">序列化数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义字段"><span class="nav-number">1.2.</span> <span class="nav-text">自定义字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SerializerMethodField"><span class="nav-number">1.3.</span> <span class="nav-text">SerializerMethodField</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#深度控制"><span class="nav-number">1.4.</span> <span class="nav-text">深度控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化源码解析"><span class="nav-number">1.5.</span> <span class="nav-text">序列化源码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反序列化"><span class="nav-number">1.6.</span> <span class="nav-text">反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#请求数据校验"><span class="nav-number">1.6.1.</span> <span class="nav-text">请求数据校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义校验"><span class="nav-number">1.6.2.</span> <span class="nav-text">自定义校验</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分页"><span class="nav-number">2.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图类"><span class="nav-number">3.</span> <span class="nav-text">视图类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#视图扩展类"><span class="nav-number">3.1.</span> <span class="nav-text">视图扩展类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由"><span class="nav-number">4.</span> <span class="nav-text">路由</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自动生成url"><span class="nav-number">4.1.</span> <span class="nav-text">自动生成url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图集中附加action的声明"><span class="nav-number">4.2.</span> <span class="nav-text">视图集中附加action的声明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#渲染器"><span class="nav-number">5.</span> <span class="nav-text">渲染器</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tigercoll"
      src="/images/p1.jpg">
  <p class="site-author-name" itemprop="name">Tigercoll</p>
  <div class="site-description" itemprop="description">万丈高楼平地起,勿在浮沙筑高台</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tigercoll" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Tigercoll" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tigercoll</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
